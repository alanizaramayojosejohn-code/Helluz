<div class="min-h-screen bg-white p-6">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-8">
      <button
        (click)="onBack()"
        class="text-gray-600 hover:text-gray-800 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <h1 class="text-4xl font-bold text-red-600">Detalle de Inscripción</h1>
    </div>

    <!-- Loading -->
    @if (isLoading()) {
      <div class="flex justify-center items-center py-12">
        <mat-spinner diameter="50"></mat-spinner>
      </div>
    }

    <!-- Error Message -->
    @if (errorMessage() && !isLoading()) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex items-center gap-3">
          <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <p class="text-sm text-red-800">{{ errorMessage() }}</p>
        </div>
      </div>
    }

    <!-- Detalle -->
    @if (enrollment() && !isLoading()) {
      <!-- Alerta de Vencimiento -->
      @if (isExpiringSoon()) {
        <div class="bg-orange-50 border-2 border-orange-500 rounded-lg p-4 mb-6">
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <div>
              <p class="font-bold text-orange-800">⚠️ Membresía próxima a vencer</p>
              <p class="text-orange-700">Esta inscripción vence en {{ daysLeft() }} días. Considera renovarla pronto.</p>
            </div>
          </div>
        </div>
      }

      <!-- Card Principal -->
      <div class="bg-white shadow-sm shadow-black border border-gray-800 rounded-lg overflow-hidden mb-6">

        <!-- Header del Detalle -->
        <div class="bg-red-600 text-white p-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full bg-white text-red-600 flex items-center justify-center font-bold text-2xl">
                {{ enrollment()!.studentName.charAt(0) }}
              </div>
              <div>
                <h2 class="text-3xl font-bold mb-1">{{ enrollment()!.studentName }}</h2>
                <p class="text-red-100 text-lg">{{ enrollment()!.membershipName }}</p>
              </div>
            </div>
            <div class="text-right">
              <mat-chip [class]="getStatusClass(enrollment()!.status) + ' text-lg px-4 py-2 font-semibold'">
                {{ enrollment()!.status === 'activa' ? 'Activa' :
                   enrollment()!.status === 'vencida' ? 'Vencida' :
                   enrollment()!.status === 'completada' ? 'Completada' : 'Cancelada' }}
              </mat-chip>
            </div>
          </div>
        </div>

        <!-- Tabs de Información -->
        <mat-tab-group class="p-6">

          <!-- Tab: Información General -->
          <mat-tab label="Información General">
            <div class="py-6 space-y-6">

              <!-- Datos de la Inscripción -->
              <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Datos de la Inscripción
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Sucursal</label>
                    <mat-chip class="bg-gray-100 text-gray-800 text-base px-4 py-2">
                      {{ enrollment()!.branchName }}
                    </mat-chip>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Membresía</label>
                    <p class="text-lg text-gray-800">{{ enrollment()!.membershipName }}</p>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Fecha de Inicio</label>
                    <p class="text-lg text-gray-800">{{ enrollment()!.startDate.toDate() | date:'dd/MM/yyyy' }}</p>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Fecha de Fin</label>
                    <div>
                      <p class="text-lg text-gray-800">{{ enrollment()!.endDate.toDate() | date:'dd/MM/yyyy' }}</p>
                      @if (enrollment()!.status === 'activa') {
                        <p class="text-sm text-gray-500 mt-1">
                          {{ daysLeft() > 0 ? daysLeft() + ' días restantes' : 'Vencida' }}
                        </p>
                      }
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Días Permitidos</label>
                    <p class="text-lg text-gray-800">{{ getAllowedDaysText(enrollment()!.allowedDays) }}</p>
                  </div>
                </div>
              </div>

              <!-- Sesiones -->
              <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                  </svg>
                  Sesiones
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-600 font-semibold mb-1">Total de Sesiones</p>
                    <p class="text-3xl font-bold text-blue-800">{{ enrollment()!.totalSessions }}</p>
                  </div>

                  <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-sm text-green-600 font-semibold mb-1">Sesiones Usadas</p>
                    <p class="text-3xl font-bold text-green-800">{{ enrollment()!.usedSessions }}</p>
                  </div>

                  <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <p class="text-sm text-orange-600 font-semibold mb-1">Sesiones Restantes</p>
                    <p class="text-3xl font-bold text-orange-800">{{ enrollment()!.remainingSessions }}</p>
                  </div>
                </div>

                <div class="mt-6">
                  <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-700 font-medium">Progreso</span>
                    <!-- <span class="text-gray-600">{{ sessionsProgress() | number:'1.0-0' }}%</span> -->
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-4">
                    <div
                      class="bg-blue-600 h-4 rounded-full transition-all flex items-center justify-end pr-2"
                      [style.width.%]="sessionsProgress()">
                      @if (sessionsProgress() > 10) {
                        <span class="text-xs text-white font-bold">{{ enrollment()!.usedSessions }}/{{ enrollment()!.totalSessions }}</span>
                      }
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pago -->
              <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                  Información de Pago
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Costo</label>
                    <p class="text-2xl font-bold text-gray-800">Bs. {{ enrollment()!.cost }}</p>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Estado de Pago</label>
                    <mat-chip [class]="getPaymentStatusClass(enrollment()!.paymentMethod) + ' text-base px-4 py-2 font-semibold'">
                      {{ enrollment()!.paymentMethod === 'Efectivo' ? 'Efectivo' :
                         enrollment()!.paymentMethod === 'Qr' ? 'Qr' : 'Efectivo' }}
                    </mat-chip>
                  </div>
                </div>
              </div>

            </div>
          </mat-tab>

          <!-- Tab: Historial de Asistencias -->
          <mat-tab label="Historial de Asistencias">
            <div class="py-6">

              @if (attendances().length === 0) {
                <div class="text-center py-12">
                  <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                  <p class="text-xl text-gray-600">No hay asistencias registradas</p>
                  <p class="text-gray-500">El alumno aún no ha asistido a ninguna clase</p>
                </div>
              } @else {
                <div class="space-y-3">
                  @for (attendance of attendances(); track attendance.id) {
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 hover:bg-gray-100 transition">
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <div class="flex items-center gap-3 mb-2">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span class="font-medium text-gray-800">
                              {{ attendance.date.toDate() | date:'EEEE, d MMMM y':'':'es' }}
                            </span>
                            <span class="text-gray-500">•</span>
                            <span class="text-gray-600">
                              {{ attendance.date.toDate() | date:'HH:mm' }}
                            </span>
                          </div>

                          <div class="flex items-center gap-4 text-sm">
                            <div class="flex items-center gap-2">
                              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                              </svg>
                              <span class="text-gray-700">{{ attendance.branchName }}</span>
                            </div>

                            <div class="flex items-center gap-2">
                              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"/>
                              </svg>
                              <span class="text-gray-700">{{ attendance.disciplineName }}</span>
                            </div>
<!--
                            @if (attendance.instructorName) {
                              <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span class="text-gray-700">{{ attendance.instructorName }}</span>
                              </div>
                            } -->
                          </div>
                        </div>

                        <mat-chip [class]="getAttendanceStatusClass(attendance.status) + ' font-semibold'">
                          {{ attendance.status === 'presente' ? 'Presente' :
                             attendance.status === 'retrasado' ? 'Retrasado' :
                             attendance.status === 'falta' ? 'Falta' : 'Permiso' }}
                        </mat-chip>
                      </div>
                    </div>
                  }
                </div>
              }

            </div>
          </mat-tab>

        </mat-tab-group>

        <!-- Acciones -->
        <div class="border-t border-gray-200 p-6 flex gap-4">
          <button
            (click)="onEdit()"
            class="flex-1 bg-gray-800 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Editar
          </button>

          @if (enrollment()!.status === 'activa') {
            <button
              (click)="onCancel()"
              [disabled]="isCanceling()"
              class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              @if (isCanceling()) {
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Cancelando...
              } @else {
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Cancelar Inscripción
              }
            </button>
          }
        </div>
      </div>
    }
  </div>
</div>
